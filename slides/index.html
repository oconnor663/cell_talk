<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <title>Interior Mutability</title>

        <link rel="stylesheet" href="dist/reset.css">
        <link rel="stylesheet" href="dist/reveal.css">
        <link rel="stylesheet" href="dist/theme/solarized.css" id="theme">

        <!-- Theme used for syntax highlighted code -->
        <link rel="stylesheet" href="plugin/highlight/solarized-dark.css" id="highlight-theme">

        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono&display=swap" rel="stylesheet">
<style>
.container{
    display: flex;
}
.col{
    flex: 1;
}
tt{
    background-color: #eee8d5;
    padding: 0 .1em;
    border-radius: .2em;
    font-family: 'Ubuntu Mono', monospace;
}
.reveal pre code{
    font-family: 'Ubuntu Mono', monospace;
    max-height: none;
}
.reveal pre ::selection{
    color: #657b83;
    background: #fdf6e3;
}
.wrap {
    display: inline-block;
    text-align: left;
}
.centercolumn {
    margin: auto;
    text-align: left;
}
.centercolumn pre {
    margin-left: 0;
    margin-right: 0;
}
.lefttext {
    padding-left: 40px;
    text-align: left;
    font-size: 0.75em;
}
</style>
    </head>
    <body>
        <div class="reveal">
            <div class="slides">



                <section>
                    <h1>Interior Mutability</h1>
                    <h2 style="color: #93a1a1">for Intermediate and Advanced Rust Programmers</h2>
                </section>





                <section style="font-size: 1.5em" data-markdown><textarea data-template>
<h2>Topics</h2>

- <tt>Mutex</tt>
- <tt>RwLock</tt>
- atomics
- <tt>RefCell</tt>
- <tt>Cell</tt>
- <tt>&amp;Cell</tt>
- <tt>UnsafeCell</tt>
                 </textarea></section>



                <section style="font-size: 2em">
                    Multithreading with <tt>Arc&lt;Mutex&lt;T&gt;&gt;</tt>
                            <pre class="rust" style="width: fit-content"><code data-trim style="padding: 1ch;"><script type="text/template">
    let my_string = Arc::new(Mutex::new(String::new()));
    let mut thread_handles = Vec::new();
    for _ in 0..10 {
        let my_string = my_string.clone();
        let thread_handle = thread::spawn(move || {
            my_string.lock().unwrap().push_str("some characters");
        });
        thread_handles.push(thread_handle);
    }
    for thread_handle in thread_handles {
        thread_handle.join().unwrap();
    }
                            </script></code></pre>
                </section>



                <section style="font-size: 2em">
                    Aliasing and mutation with <tt>Mutex</tt>
                            <pre class="rust" style="width: fit-content"><code data-trim style="padding: 1ch;"><script type="text/template">
    let my_string = Mutex::new(String::new());
    let reference1 = &my_string;
    let reference2 = &my_string;
    reference1.lock().unwrap().push_str("abc");
    reference2.lock().unwrap().push_str("def");
    assert_eq!(*my_string.lock().unwrap(), "abcdef");
                            </script></code></pre>
                </section>



                <section style="font-size: 1em">
                    Aliasing and mutation <em>without</em> <tt>Mutex</tt>
                    <div class="centercolumn" style="width: 34em">
                        <style>
                            pre {
                                margin-left: 0;
                                margin-right: 0;
                            }
                        </style>
                    <p>
                            shared references
                            <pre class="rust"><code data-trim><script type="text/template">
    let my_string = String::new();
    let reference1 = &my_string;
    let reference2 = &my_string;
    reference1.push_str("abc");
    reference2.push_str("def");
                            </script></code></pre>
                            <pre class="html"><code data-trim><script type="text/template">
error[E0596]: cannot borrow `*reference1` as mutable, as it is behind a `&` reference
 --> src/main.rs:5:5
  |
3 |     let reference1 = &my_string;
  |                      ---------- help: consider changing this to be a mutable reference: `&mut my_string`
4 |     let reference2 = &my_string;
5 |     reference1.push_str("abc");
  |     ^^^^^^^^^^ `reference1` is a `&` reference, so the data it refers to cannot be borrowed as mutable
                            </script></code></pre>
                            mutable references
                            <pre class="rust"><code data-trim><script type="text/template">
    let mut my_string = String::new();
    let reference1 = &mut my_string;
    let reference2 = &mut my_string;
    reference1.push_str("abc");
    reference2.push_str("def");
                            </script></code></pre>
                            <pre class="html"><code data-trim><script type="text/template">
error[E0499]: cannot borrow `my_string` as mutable more than once at a time
 --> src/main.rs:4:22
  |
3 |     let reference1 = &mut my_string;
  |                      -------------- first mutable borrow occurs here
4 |     let reference2 = &mut my_string;
  |                      ^^^^^^^^^^^^^^ second mutable borrow occurs here
5 |     reference1.push_str("abc");
  |     ---------- first borrow later used here
                            </script></code></pre>
                    </div>
                </section>




                <section style="font-size: 2em">
                    <tt>Mutex::lock()</tt> in the docs</tt>
                <p>
                    <a href="https://doc.rust-lang.org/std/sync/struct.Mutex.html#method.lock"><img src="mutex_lock.png"></a>
                    <a href="https://docs.rs/rustc-std-workspace-std/1.0.1/std/sync/struct.MutexGuard.html"><img src="mutexguard_derefmut.png"></a>
                </section>

                <section style="font-size: 2em">
                    <tt>Mutex::lock()</tt> in the docs</tt>
                <p>
                    <a href="https://doc.rust-lang.org/std/sync/struct.Mutex.html#method.lock"><img src="mutex_lock_arrow.png"></a>
                    <a href="https://docs.rs/rustc-std-workspace-std/1.0.1/std/sync/struct.MutexGuard.html"><img src="mutexguard_derefmut.png"></a>
                </section>






                <section style="font-size: 2em">
                    Aliasing and mutation with <tt>RwLock</tt>
                            <pre class="rust" style="width: fit-content"><code data-trim style="padding: 1ch;"><script type="text/template">
    let my_string = RwLock::new(String::new());
    let reference1 = &my_string;
    let reference2 = &my_string;
    reference1.write().unwrap().push_str("abc");
    reference2.write().unwrap().push_str("def");
    assert_eq!(*my_string.read().unwrap(), "abcdef");
                            </script></code></pre>
                </section>






                <section style="font-size: 2em">
                    Aliasing and mutation with atomics
                            <pre class="rust" style="width: fit-content"><code data-trim style="padding: 1ch;"><script type="text/template">
    let my_int = AtomicU64::new(0);
    let reference1 = &my_int;
    let reference2 = &my_int;
    reference1.fetch_add(1, Ordering::SeqCst);
    reference2.fetch_add(1, Ordering::SeqCst);
    assert_eq!(my_int.load(Ordering::SeqCst), 2);
                            </script></code></pre>
                </section>





                <section style="font-size: 1.5em">
                    Benchmarking contention
                    <div class="container">
                        <div class="col">
                            <p style="text-align: center"><tt>Mutex</tt></p>
                            <p class="lefttext">serial</p>
                            <pre class="rust"><code data-trim><script type="text/template">
    let x = Mutex::new(0);
    (0..1_000_000).into_iter().for_each(|_| {
        *x.lock().unwrap() += 1;
    });
                            </script></code></pre>
                            <p class="lefttext">parallel</tt></p>
                            <pre class="rust"><code data-trim><script type="text/template">
    let x = Mutex::new(0);
    (0..1_000_000).into_par_iter().for_each(|_| {
        *x.lock().unwrap() += 1;
    });
                            </script></code></pre>
                            <span style="font-size: 0.66em">The parallel version is 9x <u>slower</u> on my box.</span>
                        </div>
                        <div class="col">
                            <p style="text-align: center">atomics</p>
                            <p class="lefttext">serial</p>
                            <pre class="rust"><code data-trim><script type="text/template">
    let x = AtomicU64::new(0);
    (0..1_000_000).into_iter().for_each(|_| {
        x.fetch_add(1, Ordering::SeqCst);
    });
                            </script></code></pre>
                            <p class="lefttext">parallel</tt></p>
                            <pre class="rust"><code data-trim><script type="text/template">
    let x = AtomicU64::new(0);
    (0..1_000_000).into_par_iter().for_each(|_| {
        x.fetch_add(1, Ordering::SeqCst);
    });
                            </script></code></pre>
                            <span style="font-size: 0.66em">The parallel version is 3x <u>slower</u> on my box.</span>
                        </div>
                    </div>
                </section>






        <script src="dist/reveal.js"></script>
        <script src="plugin/notes/notes.js"></script>
        <script src="plugin/markdown/markdown.js"></script>
        <script src="plugin/highlight/highlight.js"></script>
        <script>
            // More info about initialization & config:
            // - https://revealjs.com/initialization/
            // - https://revealjs.com/config/
            Reveal.initialize({
                hash: true,

                width: "100%",
                height: "100%",
                margin: 0,

                transition: "none",

                // Learn about plugins: https://revealjs.com/plugins/
                plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
            });
        </script>
    </body>
</html>
